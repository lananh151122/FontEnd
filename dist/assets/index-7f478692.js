import{r as p,j as e,R as x,C as c,B as C,f as j,a as g,b as P,h as I,ba as $,ah as z}from"./index-481ffadb.js";import{Q as L}from"./quantityInput-45ab5dca.js";import{C as v}from"./index-e00b3705.js";import{T as A}from"./index.esm-cf7d7351.js";import{P as N,T as b}from"./ProCard-f8f59c62.js";import{D as B}from"./index-1fed2d2f.js";import"./CopyOutlined-d3095ff5.js";import"./index-32131d29.js";const{Text:h}=A,_=()=>{const[K,f]=p.useState(),[u,y]=p.useState([]),[S,E]=p.useState(),[w,O]=p.useState([]),D=async()=>{var s;try{f(!0);const r=(s=(await g.get(`${P.cart}`)).data)==null?void 0:s.data;r.forEach(a=>{a.selectedCombo=a.bestCombo}),y(r||[])}catch(l){I(l)}finally{f(!1)}},R=async(s,l,r)=>{try{f(!0);const a=await g.put(`${P.cart}/${s}`,{},{params:{quantity:l,voucherId:r}})}catch(a){I(a)}finally{f(!1)}},k=async()=>{try{f(!0);const s=await g.post(`${P.cart}/payment`,S);$(s.data.message)}catch(s){I(s)}finally{f(!1)}},U=()=>{var l;let s=[];for(let r of u){let a={comboId:(l=r.selectedCombo)==null?void 0:l.id,note:"",transaction:[]};for(let t of r.cartResponses)if(t.isSelected){let n={productDetailId:t.productDetailId,storeId:t.storeId,voucherCodeId:void 0,cartId:t.cartId,note:"",address:""};a.transaction.push(n)}s.push(a)}console.log("----------------> xử lý kết quả để gửi lên sever thanh toán: "),console.log(s),E(s)},q=()=>{let s=0;return w.forEach(l=>s+=l),s},F=()=>{let s=[...u];u.forEach(l=>{l.selectedCombo=l.bestCombo}),y(s)};p.useEffect(()=>{D(),F()},[]),p.useEffect(()=>{U()},[u]);const T=(s,l,r)=>{var d;let a=[...s],t=new Set,n=new Set((d=r==null?void 0:r.products)==null?void 0:d.map(o=>o.id));a.forEach(o=>{o.storeId===l&&(o.selectedCombo=r,o.cartResponses.forEach(m=>{m.isSelected?(m.comboIds.includes(r.id)?m.isInCombo=!0:m.isInCombo=!1,t.add(m.productId)):m.isInCombo=!1}))});const i=new Set([...t].filter(o=>n.has(o)));return console.log("combo?.quantityToUse: ",r==null?void 0:r.quantityToUse),console.log("productIds size: ",i.size),i.size>=(r==null?void 0:r.quantityToUse)?r.canUseCombo=!0:r.canUseCombo=!1,y(a),console.log("updatedCartItem: ",a),console.log("selectedProduct: ",t),console.log("productInCombos: ",n),console.log("=====================>comboInfo: "),console.log(r),r},G=s=>{const l=a=>{let t=[...u];T(t,s.storeId,a)},r=s.combos.map(a=>e.jsx(N,{bordered:!0,boxShadow:!0,children:e.jsxs(x,{children:[e.jsxs(c,{className:"ml-5 mr-20",children:[e.jsx(x,{className:"mb-3",children:a.comboName}),e.jsx(x,{className:"mb-3",children:a.type==="PERCENT"?e.jsxs(e.Fragment,{children:["Giảm ",a.value," %"]}):a.type==="TOTAL"?e.jsxs(e.Fragment,{children:["Giảm ",j(a.value)," "]}):e.jsx("div",{})}),e.jsxs(x,{className:"mb-3",children:["Giảm giá tối đa ",a.maxDiscount," khi mua từ ",a.quantityToUse," sản phẩm từ cửa hàng"]})]}),e.jsx(c,{className:"flex items-center justify-center",children:e.jsx(C,{type:"primary",onClick:()=>l(a),children:"Sử dụng"})})]})},a.id));if(s.combos.length>0)return e.jsxs(x,{className:"w-full bg-rose-50 p-3",children:[e.jsxs(c,{children:[e.jsx(b,{color:"red",children:"Khuyến mãi"}),!s.selectedCombo.canUseCombo&&e.jsx(b,{color:"default",children:"Chưa đủ điều kiện"})]}),e.jsx(c,{children:s.selectedCombo.comboName}),e.jsx(c,{children:e.jsxs(h,{children:[" - giảm giá tối đa ",j(s.selectedCombo.maxDiscount)]})}),e.jsx(c,{children:e.jsxs(h,{children:[" khi mua ",s.selectedCombo.quantityToUse," sản phẩm"]})}),e.jsx(c,{children:e.jsx(z,{title:"Khuyến mãi",content:r,children:e.jsxs(h,{className:"text-primary cursor-pointer hover:text-secondary",children:[" Thêm",">"]})})})]})},Q=s=>{const l=(t,n)=>{let i=[...u];i.forEach(d=>{d.storeId===s.storeId&&d.cartResponses.forEach(o=>{o.cartId===t&&(o.isSelected=n)})}),y(i),T(i,s.storeId,s.selectedCombo)},r=(t,n)=>{let i=[...u];i.forEach(d=>{d.storeId===s.storeId&&d.cartResponses.forEach(o=>{o.cartId===t&&(o.quantity=n,o.totalPrice=o.sellPrice*n)})}),y(i),R(t,n,void 0)},a=()=>{let t=0,n=0,i=s.selectedCombo;return s.cartResponses.forEach(d=>{d.isSelected&&(d.isInCombo?n+=d.totalPrice:t+=d.quantity*d.sellPrice)}),i!=null&&i.canUseCombo&&(i.type=="PERCENT"?n=n-n*(i.value/100):i.type=="TOTAL"&&(n=n-i.value)),console.log("totalPriceInCombo: ",n),console.log("totalPrice: ",t),console.log("totalPrice + totalPriceInCombo: ",t+n),t+n};return e.jsxs(N,{className:"mb-5",bordered:!0,title:s.storeName,children:[G(s),s.cartResponses.map(t=>e.jsx(e.Fragment,{children:e.jsx(N,{bordered:!0,extra:e.jsx(e.Fragment,{children:t.isInCombo&&e.jsx(b,{color:"lime",children:"Áp dụng khuyến mãi"})}),children:e.jsxs(x,{children:[e.jsx(c,{span:1,className:"flex items-center justify-center",children:e.jsx(v,{checked:t.isSelected,onChange:n=>l(t.cartId,n.target.checked)})}),e.jsx(c,{span:8,className:"flex items-center justify-center",children:e.jsxs("div",{children:[e.jsx(h,{className:"flex justify-center",children:t.productName}),e.jsxs(h,{className:"flex justify-center opacity-75",children:["(",t.productDetailName,")"]})]})}),e.jsx(c,{span:4,className:"flex items-center justify-center",children:t.discountPercent?e.jsxs("div",{className:"flex",children:[e.jsx(h,{delete:!0,className:"text-gray-400",children:j(t.price)})," - ",e.jsx(h,{className:"text-rose-500",children:j(t.totalPrice)})]}):e.jsx(h,{className:"text-rose-500",children:j(t.sellPrice)})}),e.jsx(c,{span:4,className:"flex items-center justify-center",children:e.jsx(L,{quantity:t.quantity,setQuantity:n=>r(t.cartId,n),limit:t.limit,disable:t.isDisable})}),e.jsx(c,{span:3,className:"flex items-center justify-center",children:e.jsx(h,{className:"text-rose-500",children:j(t==null?void 0:t.totalPrice)})}),e.jsx(c,{span:4,className:"flex items-center justify-center",children:e.jsxs("div",{children:[e.jsx("div",{className:"flex items-center justify-center",children:e.jsx(C,{type:"ghost",children:"Xoá"})}),e.jsx("div",{className:"flex items-center justify-center cursor-pointer",children:e.jsx(h,{className:"text-rose-500",children:"Sản phẩm tương tự "})})]})})]},t.cartId)})})),e.jsx(B,{}),e.jsxs("div",{className:"float-right",children:[e.jsx(h,{children:"Tổng tiền thanh toán cho cửa hàng: "}),e.jsxs(h,{className:"text-primary",children:[" ",j(a())," "]})]})]},s.storeId)};return e.jsxs("div",{children:[e.jsx("div",{className:"flex justify-center",children:e.jsx("div",{className:"w-2/3 flex justify-center bg-lightWhite text-center",children:e.jsx("div",{children:"Giỏ hàng"})})}),e.jsx("div",{className:"flex justify-center",children:e.jsx("div",{className:"w-2/3 mt-5 p-5 bg-white",children:e.jsxs(x,{children:[e.jsx(c,{span:1,className:"flex items-center",children:e.jsx(v,{})}),e.jsx(c,{span:8,className:"flex items-center justify-center",children:"Sản phẩm"}),e.jsx(c,{span:4,className:"flex items-center justify-center",children:"Đơn giá"}),e.jsx(c,{span:4,className:"flex items-center justify-center",children:"Số lượng"}),e.jsx(c,{span:3,className:"flex items-center justify-center",children:"Số tiền"}),e.jsx(c,{span:4,className:"flex items-center justify-center",children:"Thao tác"})]})})}),e.jsx("div",{className:"flex justify-center",children:e.jsx("div",{className:"w-2/3 pt-5",children:u.map(s=>e.jsx("div",{children:Q(s)},s.storeId))})}),e.jsx("div",{className:"flex justify-center",children:e.jsx(N,{className:"w-2/3",children:e.jsx(x,{children:e.jsx(c,{span:24,children:e.jsxs(x,{className:"p-5 ",children:[e.jsx(c,{span:4,className:"flex items-center",children:e.jsx(v,{children:"Chọn tất cả"})}),e.jsx(c,{span:4,className:"flex items-center justify-around",children:e.jsx(C,{type:"text",children:"Xóa"})}),e.jsxs(c,{span:16,className:"flex items-center justify-end",children:[e.jsxs(h,{className:"mr-2",children:["Tổng thanh toán ",j(q)]}),e.jsx(C,{type:"primary",onClick:()=>k(),children:"Mua hàng"})]})]})})})})})]})};export{_ as default};
